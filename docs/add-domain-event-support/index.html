<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-add-domain-event-support">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">6: Hands-On - Add domain event support | Tackle Eventual Consistency with Domain Events</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.the-experts.nl/tackle-eventual-consistency-with-domain-events-docs/docs/add-domain-event-support"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="6: Hands-On - Add domain event support | Tackle Eventual Consistency with Domain Events"><meta data-rh="true" name="description" content="Timebox: 25 minutes"><meta data-rh="true" property="og:description" content="Timebox: 25 minutes"><link data-rh="true" rel="icon" href="/tackle-eventual-consistency-with-domain-events-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.the-experts.nl/tackle-eventual-consistency-with-domain-events-docs/docs/add-domain-event-support"><link data-rh="true" rel="alternate" href="https://www.the-experts.nl/tackle-eventual-consistency-with-domain-events-docs/docs/add-domain-event-support" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.the-experts.nl/tackle-eventual-consistency-with-domain-events-docs/docs/add-domain-event-support" hreflang="x-default"><link rel="stylesheet" href="/tackle-eventual-consistency-with-domain-events-docs/assets/css/styles.9acb068a.css">
<link rel="preload" href="/tackle-eventual-consistency-with-domain-events-docs/assets/js/runtime~main.b872bec8.js" as="script">
<link rel="preload" href="/tackle-eventual-consistency-with-domain-events-docs/assets/js/main.a41a4b0b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tackle-eventual-consistency-with-domain-events-docs/"><div class="navbar__logo"><img src="/tackle-eventual-consistency-with-domain-events-docs/img/theexperts_ZwartOranje.png" alt="the/experts." class="themedImage_ToTc themedImage--light_HNdA" height="32" width="130"><img src="/tackle-eventual-consistency-with-domain-events-docs/img/theexperts_WitOranje.png" alt="the/experts." class="themedImage_ToTc themedImage--dark_i4oU" height="32" width="130"></div><b class="navbar__title text--truncate">Devoxx UK MiniLab</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/MaikKingma/tackle-eventual-consistency-with-domain-events/tree/get-started" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://docs.google.com/presentation/d/1_jv8KLRYHjY7-AefYU0StWXTiHKlNlzi6EGBSS4DCD0/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Slides<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">About</a><ul class="dropdown__menu"><li><a href="https://www.linkedin.com/in/maik-kingma/" target="_blank" rel="noopener noreferrer" class="dropdown__link">LinkedIn<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://twitter.com/maikkingma" target="_blank" rel="noopener noreferrer" class="dropdown__link">Twitter<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://maikkingma.medium.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Blog<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.the-experts.nl" target="_blank" rel="noopener noreferrer" class="dropdown__link">Company<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/tackle-eventual-consistency-with-domain-events-docs/"><img src="/tackle-eventual-consistency-with-domain-events-docs/img/theexperts_ZwartOranje.png" alt="the/experts." class="themedImage_ToTc themedImage--light_HNdA" height="32" width="130"><img src="/tackle-eventual-consistency-with-domain-events-docs/img/theexperts_WitOranje.png" alt="the/experts." class="themedImage_ToTc themedImage--dark_i4oU" height="32" width="130"><b>Devoxx UK MiniLab</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/intro">1: Workshop Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/eventual-consistency">2: Theory - Eventual Consistency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/Solutions">3: Theory - Solutions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/domain-events">2: Theory - Domain Events in Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/getting-to-know-the-domain">4: Hands-On - The domain</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/setting-up-an-initial-application">5: Hands-On - Set up the Application</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/tackle-eventual-consistency-with-domain-events-docs/docs/add-domain-event-support">6: Hands-On - Add domain event support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/theory-event-listener">7: Theory - Event Handlers in Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/add-event-listener">8: Hands-On - Add the event listener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/tackle-eventual-consistency-with-domain-events-docs/docs/add-kafka-publishing">8: Bonus - Add Kafka publishing</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/tackle-eventual-consistency-with-domain-events-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">6: Hands-On - Add domain event support</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>6: Hands-On - Add domain event support</h1><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="timebox-25-minutes">Timebox: 25 minutes<a href="#timebox-25-minutes" class="hash-link" aria-label="Direct link to Timebox: 25 minutes" title="Direct link to Timebox: 25 minutes">​</a></h3><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="status-quo">Status Quo<a href="#status-quo" class="hash-link" aria-label="Direct link to Status Quo" title="Direct link to Status Quo">​</a></h2><p>We got to know the domain in section 4. In our application we want to be able to register authors, write books and
publish them.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-command">The command<a href="#the-command" class="hash-link" aria-label="Direct link to The command" title="Direct link to The command">​</a></h3><p>For that purpose I prepared the <code>/commands/book/BookCommands.java</code> class containing our new command API endpoint:</p><div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /books/{id}/commands/publish HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;publisherId&quot;: &quot;80553ae1-2ef8-4adf-8fa8-d551684a9ea3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Currently, this endpoint checks, whether a book can be published and if so sets it into a publishing state and persists
it to the DB.
Our task now is to trigger a domain event that represents this publishing action. This published domain event can then
be processed
asynchronously to trigger other actions connected to the publishing request, such as the confirmation of a domain
external publisher.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="task-implement-the-domain-event-support">Task: Implement the domain event support<a href="#task-implement-the-domain-event-support" class="hash-link" aria-label="Direct link to Task: Implement the domain event support" title="Direct link to Task: Implement the domain event support">​</a></h2><p>We want to allow a publishing request and, since we aim for eventual consistency in our business process, the publishing
of a related domain
event, that can be consumed later on by our process adapter (event listener).
To be able to handle domain events in Spring, we need to add a new dependency in our <code>pom.xml</code>:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.data</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-data-commons</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-abstractaggregaterootclass">The AbstractAggregateRoot.class<a href="#the-abstractaggregaterootclass" class="hash-link" aria-label="Direct link to The AbstractAggregateRoot.class" title="Direct link to The AbstractAggregateRoot.class">​</a></h3><p>This class is meant to be extended by your aggregate root entities. By doing so, your aggregates gain the ability to
capture domain events and have them automatically published when saved or deleted via Spring Data repositories, thus
adhering to DDD principles and enhancing the expressiveness of your model with respect to domain events.</p><p><strong>Purpose:</strong> In DDD, domain events are significant occurrences within the domain. These events capture outcomes or changes
in the state of the domain that are important for the business. AbstractAggregateRoot facilitates the handling of these
events by allowing aggregates to capture and later publish them when interacting with Spring Data repositories.</p><p><strong>How it Works:</strong> The class maintains a private list (domainEvents) to store the events. Events are added to this list
through the registerEvent(T event) method, which is intended to be called within the aggregate when a state change
occurs that should be communicated as a domain event.</p><p>The challenge of this task is on the one hand to actually register domain events on the domain entity / aggregate, and
then also map them to the JPA entity which will be persisted by the Repository. That in turn will trigger the handling of
domain events in the <code>AbstractAggregateRoot.java</code>. If we sent domain events from the domain layer already, we
could encounter a chicken and egg problem, since the domain event would be sent before the JPA entity is persisted and a
possible roll back would leave us in an inconsistent state.</p><p>Let&#x27;s get started! Here are some useful snippets. Can you implement them in the correct places?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Getter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">DomainEvent</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> domainEvents </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ArrayList</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our abstract base Domain event</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DomainEvent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and the actual publishing event we want to trigger when publishing was requested. This event needs to be created within
the domain layer and added to our book aggregate during the publishing request.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RequestPublishingEvent</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">DomainEvent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Long</span><span class="token plain"> bookId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UUID</span><span class="token plain"> publisherId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following snippet provides us the support for handling the Domain events correctly in our JPA entity.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BookJPA</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AbstractAggregateRoot</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">BookJPA</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">registerDomainEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">DomainEvent</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> domainEvents</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        domainEvents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">andEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Hint:</strong> Do not forget to map the domain event from the domain layer to the JPA entity in the data layer</p></blockquote><p>In order to test the complete flow you will need to trigger the publishing of a book and then check whether the
domain event was published correctly. You can do so by adding a break point in the <code>AbstractAggregateRoot.class</code>:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@AfterDomainEventPublication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">clearDomainEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Add breakpoint here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domainEvents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This method will be called when we save the BookJPA after requesting the publishing. This afterCommit hook will show us
whether a domain event was present in the Book JPA entity.</p><p>You need to execute the http requests as follows:</p><div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### Register an author first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /authors/commands/register HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;firstName&quot;: &quot;PLACE_YOUR_FIRST_NAME&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;lastName&quot;: &quot;PLACE_YOUR_LAST_NAME&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Then write a book</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### TODO change the author id to something that exists in your DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /authors/10001/commands/writeBook HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;title&quot;: &quot;PLACE_YOUR_TILE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;genre&quot;: &quot;HORROR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### ThenPublish a book</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### TODO change the book id to something that exists in your DB and the publisherID to one that exists on your local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### instance of the publishing service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /books/10008/commands/publish HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;publisherId&quot;: &quot;80553ae1-2ef8-4adf-8fa8-d551684a9ea3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tdd">TDD<a href="#tdd" class="hash-link" aria-label="Direct link to TDD" title="Direct link to TDD">​</a></h3><p>You can tackle this task following a prepared test-driven development approach! You can find the code prepared
<a href="https://github.com/MaikKingma/tackle-eventual-consistency-with-domain-events/tree/task_5/add_domain_event_support_TDD" target="_blank" rel="noopener noreferrer">in this branch</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="solution">Solution<a href="#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h3><p>Got stuck anywhere along the way? Not to worry, you can find the fully implemented solution
<a href="https://github.com/MaikKingma/tackle-eventual-consistency-with-domain-events/tree/task_5/add_domain_event_support_DONE" target="_blank" rel="noopener noreferrer">in this branch</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/MaikKingma/tackle-eventual-consistency-with-domain-events-docs/docs/6.add-domain-event-support.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/tackle-eventual-consistency-with-domain-events-docs/docs/setting-up-an-initial-application"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">5: Hands-On - Set up the Application</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/tackle-eventual-consistency-with-domain-events-docs/docs/theory-event-listener"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">7: Theory - Event Handlers in Spring</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#timebox-25-minutes" class="table-of-contents__link toc-highlight">Timebox: 25 minutes</a></li><li><a href="#status-quo" class="table-of-contents__link toc-highlight">Status Quo</a><ul><li><a href="#the-command" class="table-of-contents__link toc-highlight">The command</a></li></ul></li><li><a href="#task-implement-the-domain-event-support" class="table-of-contents__link toc-highlight">Task: Implement the domain event support</a><ul><li><a href="#the-abstractaggregaterootclass" class="table-of-contents__link toc-highlight">The AbstractAggregateRoot.class</a></li><li><a href="#tdd" class="table-of-contents__link toc-highlight">TDD</a></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Maik Kingma, the/experts.</div></div></div></footer></div>
<script src="/tackle-eventual-consistency-with-domain-events-docs/assets/js/runtime~main.b872bec8.js"></script>
<script src="/tackle-eventual-consistency-with-domain-events-docs/assets/js/main.a41a4b0b.js"></script>
</body>
</html>