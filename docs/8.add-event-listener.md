---
sidebar_position: 8
---

# 8: Hands-On - Add the event listener

We added the logic for publishing our domain event. Now we need to add a first consumer.
By default, Spring publishes its Domain Events framework internal via the `SimpleApplicationEventMulticaster`. For now,
we will work with this default behaviour. In the next section we will update that logic to publish our domain events to 
a Kafka queue as well.

## The event listener in the process adapter

Here is an example of an `EventProcessor` that listens to an `ExampleEvent`.
```java
@Slf4j
@Component
public class EventProcessor {

    // ...

    @TransactionalEventListener(phase = AFTER_COMMIT)
    public void handleEvent(ExampleEvent event) {
        // do something
    }
}
```

> **Hint:** TransactionalEventListener is a Spring feature that allows you to listen to events that are published within a
> transaction. This is useful for publishing events that are triggered by a command. The event is only published if
> the transaction is committed successfully. If the transaction is rolled back, the event is not published.

### Task 1: Consume the RequestPublishingEvent
We defined a domain event in the previous hands-on section, namely the `Book.RequestPublishingEvent.class`.
Now create your own `EventProcessor` in the `process` package and make it listen to our `RequestPublishingEvent`.

For now, maybe add a log statement s.t. you can verify the event is consumed correctly.

## The delegate implementation
We will continue by implementing the service class ``/process/book/PublishBookDelegate.java``, that contains the business
 logic that needs to be executed when a `Book.RequestPublishingEvent.class` is fired.

Useful snippet:
````java
@Service
public class PublishBookDelegate {

  private final BookService bookService;
  private final PublisherService publisherService;


  public PublishBookDelegate(BookService bookService, PublisherService publisherService) {
    this.bookService = bookService;
    this.publisherService = publisherService;
  }

  @Transactional(propagation = REQUIRES_NEW)
  public void publishBook(Book.RequestPublishingEvent event) {
    // retrieve book by id from event
    
   // request the publishing of the book via the Publisher ACL layer (also see API docs below)

    // update the isbn of the book you received as a response and then store the book
  }
}
````

The API on the publisher service is defined as follows:
```http request
POST /publishers/receiveBookOffer
Host: localhost:8081
Content-Type: application/json

{
  "publisherId": "<SOME-UUID>",
  "author": "author name",
  "title": "Cool Title"
}

Returns:
{
  "isbn": "ISBN-3895b77d-ee27-40de-9b08-bf24fe2a013a"
}
```

### Validate

Let's test your implementation:
